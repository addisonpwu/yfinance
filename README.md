# 靈活的股票篩選器 (Flexible Stock Screener)

這是一個基於 Python 的股票篩選專案，採用模組化設計，旨在根據多種可擴充的、經過專業交易邏輯強化的策略，從美國和香港股市中找出符合特定條件的股票。

## 專案架構

專案已重構成模組化架構，將數據獲取、策略定義和分析引擎完全分離，以實現最大的靈活性和可擴充性。

-   `main.py`: 專案的主入口，負責解析參數、調度分析並輸出結果。
-   `data_loader/`: 負責從不同來源獲取股票代碼列表。
-   `strategies/`: 存放所有選股策略。您可以輕鬆地在此處添加自己的策略。
-   `analysis/`: 核心分析引擎，負責執行所有策略並篩選股票。

## 內建策略

目前專案內建了四種經過專業優化的策略，涵蓋了趨勢、動能、均值回歸等關鍵的市場分析維度。

### 1. VCP口袋支點 (VCP_PocketPivotStrategy)
**王牌策略**：此策略融合了兩種強大的交易模型，旨在VCP（波動收縮）形態的末端，尋找「口袋支點」作為早期介入信號，力求在股價主升浪開始前捕捉到最精準的買點。

-   **VCP背景篩選**：
    -   **市場地位**: 要求股價處於接近52週高點的強勢區域。
    -   **趨勢健康度**: 要求主要均線(50, 150, 200)呈多頭排列，且長期均線趨勢向上。
    -   **波動率收縮**: 量化確認股價的短期波動率小於中、長期波動率。
    -   **成交量萎縮**: 確認在訊號出現前，成交量處於整理萎縮狀態。
-   **口袋支點觸發**：
    -   **成交量訊號**: 當日成交量必須壓倒近期所有賣壓（下跌日成交量），且高於平均成交量。
    -   **價格行為**: 當日必須為上漲的紅K棒，且最低價獲得關鍵均線的有力支撐。

### 2. 主力吸籌 (MainForceAccumulationStrategy)
此策略旨在捕捉大型機構投資者在市場上悄悄吸納籌碼的行為特徵。

-   **雙重趨勢確認**：要求股價同時站上短期和長期均線，且與長期均線的乖離率受控。
-   **雙重資金流確認**：結合OBV指標的斜率與均線，雙重確認資金淨流入。
-   **成交量與波動率**：要求成交量顯著放大，但近期價格波動平穩。

### 3. 黃金交叉 (GoldenCrossStrategy)
一個經典的長線趨勢反轉策略，加入了多重過濾器以提高信號的準確性。

-   **大盤濾網**：只在整體市場處於多頭趨勢時，此策略才會被觸發。
-   **訊號強化**：結合趨勢強度、成交量、RSI、乖離率和K線形態等多重過濾器。

### 4. 均值回歸 (MeanReversionStrategy)
旨在捕捉股價超跌後的潛在反彈機會，同樣加入了多重確認機制。

-   **雙重止穩確認**：要求K線出現「更高低點」，並且當日必須為「紅K棒」。
-   **多維度過濾**：結合趨勢、價格區間（威廉指標）和成交量模式進行綜合判斷。

## 功能

-   **模組化設計**：輕鬆添加新策略，而無需修改核心程式碼。
-   **雙市場支援**：透過命令列參數即可切換美國 (`US`) 和香港 (`HK`) 市場。
-   **自動化列表獲取**：
    -   美股：自動從 `statementdog.com` 獲取一個廣泛的美股列表。
    -   港股：自動從港交所(HKEX)網站下載最新的證券列表。
-   **動態策略加載**：分析引擎會自動偵測並執行 `strategies` 文件夾中的所有策略。
-   **簡潔的結果輸出**：結果會以逗號分隔的格式 (如 `NASDAQ:AAPL,NYSE:MSFT`) 儲存到對應市場的 `.txt` 檔案中，方便直接複製貼上至其他軟體使用。

## 安裝與設定

1.  **建立虛擬環境** (建議)
    ```bash
    python3 -m venv venv
    ```

2.  **啟用虛擬環境**
    -   在 macOS / Linux 上:
        ```bash
        source venv/bin/activate
        ```
    -   在 Windows 上:
        ```bash
        .\venv\Scripts\activate
        ```

3.  **安裝所需套件**
    ```bash
    pip install -r requirements.txt
    ```

## 使用方法

所有操作都透過 `main.py` 執行，並使用 `--market` 參數指定要分析的市場。

### 篩選美股

```bash
python3 main.py --market US
```
-   **過程**：腳本會自動獲取美股列表，然後使用所有可用策略進行分析。
-   **輸出**：符合條件的股票列表將以逗號分隔的格式儲存到 `us_stocks_YYYY-MM-DD.txt` 檔案中。

### 篩選港股

```bash
python3 main.py --market HK
```
-   **過程**：腳本會自動下載港交所的股票列表，然後使用所有可用策略進行分析。
-   **輸出**：符合條件的股票列表將以逗號分隔的格式儲存到 `hk_stocks_YYYY-MM-DD.txt` 檔案中。

## 如何擴充 (增加新策略)

這是此架構的核心優勢。若要增加一個新的選股策略，只需：

1.  在 `strategies/` 資料夾中建立一個新的 Python 檔案 (例如 `my_new_strategy.py`)。
2.  在該檔案中，建立一個繼承自 `BaseStrategy` 的新策略類別。
3.  實現 `name` 屬性 (策略名稱) 和 `run` 方法 (策略邏輯)。

**範例 `strategies/my_new_strategy.py`:**
```python
import pandas as pd
from .base_strategy import BaseStrategy

class MyNewStrategy(BaseStrategy):
    @property
    def name(self):
        return "我的新策略"

    def run(self, hist: pd.DataFrame, **kwargs) -> bool:
        # 在此實現您的策略邏輯
        # 例如，尋找收盤價高於 200 日均線的股票
        if len(hist) < 200:
            return False
        
        hist['MA200'] = hist['Close'].rolling(window=200).mean()
        latest_close = hist['Close'].iloc[-1]
        latest_ma200 = hist['MA200'].iloc[-1]

        if latest_close > latest_ma200:
            return True
        
        return False
```
完成後，分析引擎會自動偵測並執行您的新策略，無需修改任何其他程式碼！

---

## 開發日誌

-   **2025-10-06**:
    -   **王牌策略整合**: 根據專家建議，將VCP（波動收縮）與口袋支點（Pocket Pivot）兩種進階邏輯整合為單一、強大的`VCP_PocketPivotStrategy`策略。
    -   **策略強化**: 為新的整合策略加入了多重嚴格的過濾條件，包括52週高點位置、均線斜率、成交量模式、K線支撐等。
    -   **代碼重構**: 清理了舊的獨立策略檔案，完成了最終的策略整合。

-   **2025-10-05**:
    -   **策略強化**: 根據專家建議，再次強化了「均值回歸」與「黃金交叉」策略，為其增加了多重過濾器（如大盤狀態、K線形態等），並將所有關鍵參數進行了參數化，使其更為穩健與靈活。
    -   **功能增加**: 為輸出檔案加上日期（例如 `us_stocks_2025-10-05.txt`），方便歷史回查。

-   **2025-10-04**:
    -   **策略迭代**: 使用更先進的「主力吸籌」策略，取代了原有的基礎動能策略，並對其進行了深度優化。
    -   **格式調整**: 統一了輸出檔案的格式為逗號分隔，並修正了港股代碼的顯示方式。
    -   **核心重構**: 專案進行了重大重構，引入了模組化架構，分離了數據獲取、策略定義和分析引擎。