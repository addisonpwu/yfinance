# 靈活的股票篩選器 (Flexible Stock Screener)

這是一個基於 Python 的股票篩選專案，採用模組化設計，旨在根據多種可擴充的策略，從美國和香港股市中找出符合特定條件的股票。

## 專案架構

專案已重構成模組化架構，將數據獲取、策略定義和分析引擎完全分離，以實現最大的靈活性和可擴充性。

-   `main.py`: 專案的主入口，負責解析參數、調度分析並輸出結果。
-   `data_loader/`: 負責從不同來源獲取股票代碼列表。
-   `strategies/`: 存放所有選股策略。您可以輕鬆地在此處添加自己的策略。
-   `analysis/`: 核心分析引擎，負責執行所有策略並篩選股票。

## 內建策略

目前專案內建了三種經過專業優化的策略，分別代表不同的市場分析維度。

### 1. 優化版主力吸籌 (MainForceAccumulationStrategy)
此策略旨在捕捉大型機構投資者（主力）在市場上悄悄吸納籌碼的行為特徵。

-   **雙重趨勢確認**：要求股價同時站上20日（短期）和100日（長期）均線，且與長期均線的乖離率受控，確保趨勢健康。
-   **雙重資金流確認**：要求OBV（能量潮）指標的短期斜率向上，且OBV值本身站上其移動平均線，雙重確認資金淨流入。
-   **成交量放大**：當日成交量必須顯著高於60日均量，作為主力進場的信號。
-   **波動率控制**：使用ATR（平均真實波幅）指標確保近期股價波動平穩，排除暴漲暴跌的股票。
-   **當日力道**：要求當日收盤價位於K線的上半部，確認買盤強勁。

### 2. 優化版黃金交叉 (GoldenCrossStrategy)
一個經典的長線趨勢反轉策略，加入了多重過濾器以提高信號的準確性。

-   **核心訊號**：50日均線向上穿越200日均線。
-   **趨勢過濾**：要求200日均線本身必須走平或向上，過濾「死貓跳」式的假突破。
-   **成交量確認**：交叉當日成交量必須顯著放大。
-   **動能過濾**：使用RSI指標排除處於超買狀態的股票。
-   **乖離率過濾**：限制股價與長期均線的距離，避免追高。

### 3. 優化版均值回歸 (MeanReversionStrategy)
旨在捕捉股價超跌後的潛在反彈機會，此版本經過專家建議優化，加入了更嚴格的確認機制。

-   **核心訊號**：股價跌破布林通道下軌。
-   **趨勢過濾**：在長期下降趨勢中，會等待短期趨勢有止穩跡象才考慮。
-   **雙重止穩確認**：要求K線出現「更高低點 (Higher Low)」，並且當日K線必須為「紅K」，雙重確保止跌力道。
-   **價格區間**：使用威廉指標 (%%R) 確保股價處於深度超賣但非極端恐慌的區間。
-   **成交量確認**：要求近期有出現成交量萎縮，且當日成交量回升。
-   **完全參數化**：所有關鍵閾值（布林通道參數、威廉指標範圍等）皆可調整。

## 功能

-   **模組化設計**：輕鬆添加新策略，而無需修改核心程式碼。
-   **雙市場支援**：透過命令列參數即可切換美國 (`US`) 和香港 (`HK`) 市場。
-   **自動化列表獲取**：
    -   美股：自動從 `statementdog.com` 獲取一個廣泛的美股列表。
    -   港股：自動從港交所(HKEX)網站下載最新的證券列表。
-   **動態策略加載**：分析引擎會自動偵測並執行 `strategies` 文件夾中的所有策略。
-   **簡潔的結果輸出**：結果會以逗號分隔的格式 (如 `NASDAQ:AAPL,NYSE:MSFT`) 儲存到對應市場的 `.txt` 檔案中，方便直接複製貼上至其他軟體使用。

## 安裝與設定

1.  **建立虛擬環境** (建議)
    ```bash
    python3 -m venv venv
    ```

2.  **啟用虛擬環境**
    -   在 macOS / Linux 上:
        ```bash
        source venv/bin/activate
        ```
    -   在 Windows 上:
        ```bash
        .\venv\Scripts\activate
        ```

3.  **安裝所需套件**
    ```bash
    pip install -r requirements.txt
    ```

## 使用方法

所有操作都透過 `main.py` 執行，並使用 `--market` 參數指定要分析的市場。

### 篩選美股

```bash
python3 main.py --market US
```
-   **過程**：腳本會自動獲取美股列表，然後使用所有可用策略進行分析。
-   **輸出**：符合條件的股票列表將以逗號分隔的格式儲存到 `us_stocks.txt` 檔案中。
    -   範例: `NASDAQ:AAPL,NYSE:MSFT,NASDAQ:GOOGL`

### 篩選港股

```bash
python3 main.py --market HK
```
-   **過程**：腳本會自動下載港交所的股票列表，然後使用所有可用策略進行分析。
-   **輸出**：符合條件的股票列表將以逗號分隔的格式儲存到 `hk_stocks.txt` 檔案中。
    -   範例: `HKEX:700,HKEX:1810,HKEX:9988`

## 如何擴充 (增加新策略)

這是此架構的核心優勢。若要增加一個新的選股策略，只需：

1.  在 `strategies/` 資料夾中建立一個新的 Python 檔案 (例如 `my_new_strategy.py`)。
2.  在該檔案中，建立一個繼承自 `BaseStrategy` 的新策略類別。
3.  實現 `name` 屬性 (策略名稱) 和 `run` 方法 (策略邏輯)。

**範例 `strategies/my_new_strategy.py`:**
```python
import pandas as pd
from .base_strategy import BaseStrategy

class MyNewStrategy(BaseStrategy):
    @property
    def name(self):
        return "我的新策略"

    def run(self, hist: pd.DataFrame, **kwargs) -> bool:
        # 在此實現您的策略邏輯
        # 例如，尋找收盤價高於 200 日均線的股票
        if len(hist) < 200:
            return False
        
        hist['MA200'] = hist['Close'].rolling(window=200).mean()
        latest_close = hist['Close'].iloc[-1]
        latest_ma200 = hist['MA200'].iloc[-1]

        if latest_close > latest_ma200:
            return True
        
        return False
```
完成後，分析引擎會自動偵測並執行您的新策略，無需修改任何其他程式碼！

---

## 開發日誌

-   **2025-10-05 (凌晨)**:
    -   **策略強化**: 再次根據專家建議，強化了「均值回歸」策略。
    -   **參數化**: 將策略中的所有關鍵數字參數化，大幅提高靈活性。
    -   **訊號增強**: 為止穩條件增加了「紅K棒」確認，使訊號更可靠。

-   **2025-10-04 (深夜)**:
    -   **策略升級**: 根據專家建議，再次大幅強化了「主力吸籌」策略，為其增加了多重過濾器（雙重趨勢、雙重OBV、波動率控制等），並將所有關鍵參數進行了參數化，使其更為穩健與靈活。
    -   **策略替換**: 使用更先進的「優化版主力吸籌」策略，完全取代了原有的兩個基礎動能策略。

-   **2025-10-04 (晚上)**:
    -   **強化**: 根據專業交易邏輯，大幅強化了「均值回歸」與「黃金交叉」策略。
    -   **新增過濾器**: 為策略加入了趨勢、成交量、RSI、乖離率等多重過濾條件，旨在提高訊號品質。
    -   **重構**: 將新增的策略分拆到獨立的檔案中，使 `strategies` 目錄結構更清晰。

-   **2025-10-04 (下午)**:
    -   **調整**: 根據使用者回饋，調整了輸出檔案的格式。
    -   **格式化**: 將輸出從多行詳細資訊改為單行逗號分隔的 `交易所:代碼` 格式，方便後續處理。
    -   **修正**: 移除了港股代碼輸出時的補零 (`zfill`)，使其符合常見使用習慣 (例如 `HKEX:700`)。

-   **2025-10-04 (上午)**:
    -   **重構**: 專案進行了重大重構，引入了模組化架構。
    -   **分離**: 將數據下載 (`data_loader`)、策略定義 (`strategies`) 和分析引擎 (`analysis`) 完全分離。
    -   **新增**: 建立了 `main.py` 作為統一的程式入口，並支援 `--market` 參數。
    -   **優化**: 實現了策略的動態加載，使擴充新策略變得極為簡單。
    -   **清理**: 移除了舊的 `momentum_screener.py` 和 `hk_stock_screener.py` 腳本。