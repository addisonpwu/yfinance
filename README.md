# 靈活的股票篩選器 (Flexible Stock Screener)

這是一個基於 Python 的股票篩選專案，採用模組化設計，旨在根據多種可擴充的、經過專業交易邏輯強化的策略，從美國和香港股市中找出符合特定條件的股票。

## 專案架構

專案已重構成模組化架構，將數據獲取、策略定義和分析引擎完全分離，以實現最大的靈活性和可擴充性。

-   `main.py`: 專案的主入口，負責解析參數、調度分析並輸出結果。
-   `data_loader/`: 負責從不同來源獲取股票代碼列表（美股從 statementdog.com，港股從 hkex.com.hk）。
-   `strategies/`: 存放所有選股策略。您可以輕鬆地在此處添加自己的策略。
-   `analysis/`: 核心分析引擎，負責執行所有策略並篩選股票，整合了 Kronos 預測模型。
-   `news_analyzer.py`: 新聞情感分析模組，使用 Playwright 從雅虎財經抓取並分析新聞。
-   `Kronos/`: AI 預測模型模組，為港股提供未來走勢預測。
-   `data_cache/`: 用於緩存股票數據，提升重複運行效率。

## 主要功能

-   **模組化設計**：輕鬆添加新策略，而無需修改核心程式碼。
-   **雙市場支援**：透過命令列參數即可切換美國 (`US`) 和香港 (`HK`) 市場。
-   **動態策略加載**：分析引擎會自動偵測並執行 `strategies` 文件夾中的所有策略。
-   **高效數據緩存**: 引入了智能數據緩存機制，大幅提升二次運行的速度。
-   **AI 預測整合**: 為港股整合了 Kronos Transformer 模型，提供未來走勢的概率性預測。
-   **新聞情感分析**: 自動抓取並分析入選股票的最新新聞情感，提供市場情緒參考。
-   **豐富的結果輸出**：
    -   **詳細報告**：程式會生成一份詳細報告檔案 (`..._details.txt`)，其中包含每支入選股票的基本面資訊（市值、市盈率等）、Kronos 預測結果和最新新聞情感分析，方便進行深度分析。
    -   **簡潔摘要**：同時，一個簡潔的摘要列表也會被儲存到對應市場的 `.txt` 檔案中，方便直接複製貼上至其他軟體使用。

## Kronos AI 預測模型整合

本專案已整合 Kronos 預測模型，為通過篩選的香港股票提供額外的 AI 預測信息。

### 技術特點
- **Transformer 架構**: 基於自回归 Transformer 模型
- **兩階段框架**: 量化器编码 + Transformer 預測
- **全球支援**: 支援全球 45+ 交易所數據
- **概率性預測**: 提供未來 10 天的上升/下跌概率

### 使用方式
- **自動預測**: 對於符合篩選條件的香港股票，系統將自動調用 Kronos 模型進行預測
- **結果顯示**: Kronos 的預測結果（上升概率百分比）將顯示在控制台輸出和詳細報告中
- **模型來源**: 從 Hugging Face Hub 加載預訓練模型 (`NeoQuasar/Kronos-base`)

## 數據緩存與性能

為了極大化效率並減少不必要的網絡請求，本項目實現了一套智能數據緩存系統。

-   **工作目錄**: 所有緩存數據存放在 `data_cache/` 目錄下，並為不同市場（`US`, `HK`）創建了獨立的子目錄。
-   **數據分離緩存**:
    -   **歷史價格 (`.csv`)**: 每支股票的歷史價格數據（開、高、低、收、量）被緩存為一個獨立的 `.csv` 文件。
    -   **基本面信息 (`.json`)**: 每支股票的基本面信息（如市值、行業、流通股本等）被緩存為一個 `.json` 文件。
-   **全局版本控制 (`version.txt`)**:
    -   每個市場的緩存目錄下都有一個 `version.txt` 文件，記錄著上次成功同步數據的日期。
    -   當您運行程序時，它會首先檢查這個版本文件。
    -   **快速模式**: 如果記錄的日期是今天，程序將進入「快速模式」，直接從本地緩存讀取所有數據，實現秒級啟動。
    -   **同步模式**: 如果日期不是今天，程序會自動進入「同步模式」，檢查每支股票的數據，僅下載需要更新的增量部分，然後在成功結束後更新 `version.txt`。

## 內建策略

目前專案內建了多種經過專業優化的策略，涵蓋了趨勢、動能、均值回歸等關鍵的市場分析維度。

### 1. VCP口袋支點 (VCP_PocketPivotStrategy)
**王牌策略**：此策略融合了兩種強大的交易模型，旨在VCP（波動收縮）形態的末端，尋找「口袋支點」作為早期介入信號，力求在股價主升浪開始前捕捉到最精準的買點。

### 2. 主力吸籌 (MainForceAccumulationStrategy)
此策略旨在更精準地捕捉大型機構投資者在拉升前，於市場上悄悄吸納籌碼的「潛伏」階段。

### 3. 黃金交叉 (GoldenCrossStrategy)
一個經典的長線趨勢反轉策略，加入了多重過濾器（如大盤狀態、趨勢斜率、RSI等）以提高信號的準確性。

### 4. 均值回歸 (MeanReversionStrategy)
旨在捕捉股價超跌後的潛在反彈機會，加入了多重確認機制（如止穩K線、威廉指標、成交量模式等）。

### 5. 內部日反轉 (InsideDayStrategy)
此策略旨在捕捉下降趨勢中的潛在轉折點，專門尋找「牛市中的回檔結束點」，形態要求嚴格，並有次日突破作為確認。

### 6. 布林帶擠壓突破 (BollingerSqueezeStrategy)
此策略旨在捕捉由長期盤整、波動率極度壓縮的狀態，轉變為趨勢行情（主升浪）的起爆點。

### 7. 換手率動量突破 (TurnoverMomentumBreakoutStrategy)
此策略旨在尋找換手率近期有顯著放大，且股價處於短期上升趨勢的股票，預示著市場關注度提高和潛在的價格突破。
- **動量確認**: 要求當日換手率變化率遠高於近期平均，且換手率本身達到一定閾值（如 > 3%）。
- **趨勢過濾**: 確保股價處於短期上升趨勢（如收盤價 > 5日均線）。
- **基本面過濾**: 排除市值過小和價格過低的股票，以保證流動性和稳定性。

## 安裝與設定

為了確保所有依賴項的兼容性，建議使用 Python 3.12 建立虛擬環境。

1.  **建立虛擬環境 (使用 Python 3.12)**:
    ```bash
    python3.12 -m venv venv
    ```
2.  **啟用虛擬環境**:
    ```bash
    source venv/bin/activate  # macOS/Linux
    # 或 .\venv\Scripts\activate  # Windows
    ```
3.  **安裝 PyTorch (單獨安裝)**:
    由於 PyTorch 在某些 Python 版本和平台上可能需要特定的安裝方式，請使用以下命令單獨安裝：
    ```bash
    pip install torch torchvision torchaudio --extra-index-url https://download.pytorch.org/whl/cpu
    ```
4.  **安裝其餘所需套件**:
    ```bash
    pip install -r requirements.txt
    pip install -r Kronos/requirements.txt
    ```

## 使用方法

所有操作都透過 `main.py` 執行，並使用命令列參數指定要分析的市場和運行模式。

```bash
# 篩選美股 (首次運行會較慢，之後會啟用快速模式)
python3 main.py --market US

# 篩選港股
python3 main.py --market HK

# 強制快速模式（跳過緩存更新，直接使用現有緩存數據）
python3 main.py --market HK --no-cache-update

# 跳過 Kronos 預測（僅適用於港股）
python3 main.py --market HK --no-kronos

# 分析指定單一股票
python3 main.py --market HK --symbol 0017.HK

# 使用小時線數據進行分析
python3 main.py --market HK --interval 1h

# 使用分鐘線數據進行分析（僅最近7天）
python3 main.py --market HK --interval 1m

# 組合使用：分析指定股票並跳過 Kronos 預測
python3 main.py --market HK --symbol 0017.HK --no-kronos

# 組合使用：使用小時線數據分析指定股票
python3 main.py --market HK --symbol 0017.HK --interval 1h
```

### 參數說明
- `--market`: 必需參數，指定要分析的市場 (`US` 或 `HK`)
- `--no-cache-update`: 可選參數，跳過緩存更新，直接使用現有緩存數據（適用於當天已同步過數據的情況）
- `--no-kronos`: 可選參數，跳過 Kronos 預測（僅適用於港股）。使用此參數時，符合策略的股票將直接進入最終篩選結果，不會經過 Kronos 機率過濾
- `--symbol`: 可選參數，指定分析單一股票代碼（例如：0017.HK）。使用此參數時，只會分析該股票，不會掃描整個市場
- `--interval`: 可選參數，指定數據時段類型（默認為 `1d`）：
  - `1d`: 日線數據（默認，下載全部歷史數據）
  - `1h`: 小時線數據（下載最近2年數據）
  - `1m`: 分鐘線數據（僅下載最近7天數據，適合短期分析）

**注意**：不同的 interval 會使用不同的緩存文件，例如 `0017.HK_1d.csv`、`0017.HK_1h.csv`、`0017.HK_1m.csv`，互不影響。

## AI 分析功能

專案整合了 iFlow API（心流開放平台）的 AI 分析功能，為篩選結果提供專業的技術分析：

### 功能特色
- **智能分析引擎**: 使用 iFlow API 的 AI 模型對股票進行全面技術分析
- **多維度分析**: 涵蓋趨勢分析、支撐阻力、動能指標、成交量分析等 8 個維度
- **歷史數據**: 基於最近 100 天的歷史數據進行深度分析
- **實時模型**: 顯示實際使用的 AI 模型名稱（如 deepseek-v3.2）
- **標準化輸出**: 統一的輸出格式，確保一致性

### 分析內容
AI 分析包含以下 8 個詳細部分：
1. **趨勢分析**: 判斷當前趨勢方向和強度
2. **支撐與阻力**: 識別關鍵價位區間
3. **動能指標分析**: RSI、MACD 等指標的解讀
4. **成交量分析**: 量價關係和資金流向
5. **形態識別**: K 線形態和價格模式
6. **短期走勢預測**: 未來 1-3 日的走勢判斷
7. **風險評估**: 當前風險級別和建議
8. **投資建議**: 基於以上分析的買賣建議
   - 明確建議：強烈買入/買入/持有/賣出/強烈賣出
   - 建議理由：基於技術面和基本面的詳細解釋
   - 建議倉位：建議投入資金比例
   - 建議持倉週期：短期/中期/長期
   - **價位建議**：如果是買入或強烈買入建議，會提供：
     * 建議買入價位：具體的買入價格區間或價格點
     * 建議賣出價位：具體的賣出目標價格
     * 止損價位：具體的止損價格

### 顯示方式
- AI 分析結果會顯示在控制台輸出中
- 包含 AI 分析摘要和使用的模型名稱
- 支援美股和港股市場

---

## 如何擴充 (增加新策略)

這是此架構的核心優勢。若要增加一個新的選股策略，只需：

1.  在 `strategies/` 資料夾中建立一個新的 Python 檔案 (例如 `my_new_strategy.py`)。
2.  在該檔案中，建立一個繼承自 `BaseStrategy` 的新策略類別。
3.  實現 `name` 屬性 (策略名稱) 和 `run` 方法 (策略邏輯)。

**範例 `strategies/my_new_strategy.py`:**
```python
import pandas as pd
from .base_strategy import BaseStrategy

class MyNewStrategy(BaseStrategy):
    @property
    def name(self):
        return "我的新策略"

    def run(self, hist: pd.DataFrame, **kwargs) -> bool:
        # kwargs 中包含 'info' (dict), 'is_market_healthy' (bool) 等額外數據
        # 'info' 包含了市值、行業等基本面信息，可以直接使用
        info = kwargs.get('info', {})
        market_cap = info.get('marketCap', 0)

        # 實現您的策略邏輯
        # 例如，尋找市值大於100億且收盤價高於200日均線的股票
        if market_cap < 10_000_000_000:
            return False

        if len(hist) < 200:
            return False
        
        hist['MA200'] = hist['Close'].rolling(window=200).mean()
        latest_close = hist['Close'].iloc[-1]
        latest_ma200 = hist['MA200'].iloc[-1]

        if latest_close > latest_ma200:
            return True
        
        return False
```
完成後，分析引擎會自動偵測並執行您的新策略，無需修改任何其他程式碼！

## 新聞情感分析功能

專案整合了強大的新聞情感分析功能，為篩選結果提供額外的市場情緒參考：

### 功能特色
- **自動抓取**: 使用 Playwright 從雅虎財經抓取每支入選股票的最新新聞
- **情感分類**: 基於關鍵詞智能分析新聞標題的情感傾向
  - 🟢 **利好**: 包含正面關鍵詞（如 record profit, beats estimates, upgrades）
  - 🔴 **利空**: 包含負面關鍵詞（如 profit warning, investigation, lawsuit）
  - ⚪️ **中性**: 無明顯情感傾向
- **結果展示**: 情感分析結果會顯示在詳細報告中，方便快速了解市場情緒

### 實現方式
- 新聞分析在篩選完成後自動執行
- 每支股票最多獲取 5 條最新新聞
- 支援美股和港股市場

---

## 開發日誌

-   **2026-01-21**:
    -   **新增功能 (AI 分析)**: 整合 iFlow API（心流開放平台）的 AI 分析功能，提供 8 維度的技術分析，包括趨勢分析、支撐阻力、動能指標等。
    -   **AI 分析增強**: 投資建議中增加價位建議功能，當建議買入時會提供具體的買入價位、賣出價位和止損價位。
    -   **新增參數 (--interval)**: 支持選擇數據時段類型（1d 日線、1h 小時線、1m 分鐘線），不同時段使用獨立的緩存文件。
    -   **新增參數 (--symbol)**: 支持分析指定單一股票，無需掃描整個市場。
    -   **新增參數 (--no-kronos)**: 支持跳過 Kronos 預測，僅使用策略篩選。
    -   **AI 分析優化**: 使用 100 天歷史數據進行更深入的分析，標準化輸出格式，顯示實際使用的 AI 模型。

-   **2026-01-20**:
    -   **新增功能 (新聞情感分析)**: 整合了新聞情感分析模組，自動抓取並分析入選股票的最新新聞情感。
    -   **代碼清理**: 移除了無用的文件和代碼，優化項目結構。

-   **2025-10-14**:
    -   **新增策略 (換手率動量突破)**: 根據使用者需求，新增了`TurnoverMomentumBreakoutStrategy`，旨在捕捉換手率激增的動量股。
    -   **性能優化 (全局緩存)**: 引入了每個市場獨立的全局版本控制 (`version.txt`) 和 `info` 對象的JSON緩存。在數據為最新時，程序將以「快速模式」運行，完全從本地緩存加載數據，實現秒級啟動。
    -   **架構升級**: 重構了分析引擎，現在所有策略在运行时都可以接收包含市值、行業等基本面數據的 `info` 對象，使策略的過濾維度更豐富。

-   **2025-10-07**:
    -   **功能擴充 (基本面與新聞)**: 分析結果現在包含豐富的基本面數據和近期相關新聞，並會生成一份獨立的詳細報告檔案 (`_details.txt`)。
    -   **數據獲取優化**: 將歷史數據的獲取週期改為「全部歷史數據 (max)」。
    -   **錯誤修復**: 修復了因部分股票缺少財務數據而導致程式崩潰的 `ValueError`。

-   **2025-10-06**:
    -   **王牌策略整合**: 將VCP與口袋支點兩種進階邏輯整合為單一、強大的`VCP_PocketPivotStrategy`策略。

-   **2025-10-05**:
    -   **策略強化**: 為「均值回歸」與「黃金交叉」策略增加了多重過濾器。
    -   **功能增加**: 為輸出檔案加上日期，方便歷史回查。

-   **2025-10-04**:
    -   **核心重構**: 專案進行了重大重構，引入了模組化架構，分離了數據獲取、策略定義和分析引擎。