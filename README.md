# 靈活的股票篩選器 (Flexible Stock Screener)

這是一個基於 Python 的股票篩選專案，採用模組化設計，旨在根據多種可擴充的、經過專業交易邏輯強化的策略，從美國和香港股市中找出符合特定條件的股票。

## 專案架構

專案已重構成模組化架構，將數據獲取、策略定義和分析引擎完全分離，以實現最大的靈活性和可擴充性。

-   `main.py`: 專案的主入口，負責解析參數、調度分析並輸出結果。
-   `data_loader/`: 負責從不同來源獲取股票代碼列表。
-   `strategies/`: 存放所有選股策略。您可以輕鬆地在此處添加自己的策略。
-   `analysis/`: 核心分析引擎，負責執行所有策略並篩選股票。
-   `data_cache/`: 用於緩存股票數據，提升重複運行效率。

## 主要功能

-   **模組化設計**：輕鬆添加新策略，而無需修改核心程式碼。
-   **雙市場支援**：透過命令列參數即可切換美國 (`US`) 和香港 (`HK`) 市場。
-   **動態策略加載**：分析引擎會自動偵測並執行 `strategies` 文件夾中的所有策略。
-   **高效數據緩存 (新)**: 引入了智能數據緩存機制，大幅提升二次運行的速度。
-   **豐富的結果輸出**：
    -   **詳細報告**：程式會生成一份詳細報告檔案 (`..._details.txt`)，其中包含每支入選股票的基本面資訊（市值、市盈率等）和最新的相關新聞，方便進行深度分析。
    -   **簡潔摘要**：同時，一個簡潔的摘要列表也會被儲存到對應市場的 `.txt` 檔案中，方便直接複製貼上至其他軟體使用。

## Kronos 預測模型整合 (新)

本專案已整合 Kronos 預測模型，為通過篩選的香港股票提供額外的預測信息。

-   **自動預測**: 對於符合篩選條件的香港股票，系統將自動調用 Kronos 模型進行預測。
-   **結果顯示**: Kronos 的預測結果將顯示在控制台輸出和詳細報告中，為您的投資決策提供更多維度的參考。

## 數據緩存與性能 (新)

為了極大化效率並減少不必要的網絡請求，本項目實現了一套智能數據緩存系統。

-   **工作目錄**: 所有緩存數據存放在 `data_cache/` 目錄下，並為不同市場（`US`, `HK`）創建了獨立的子目錄。
-   **數據分離緩存**:
    -   **歷史價格 (`.csv`)**: 每支股票的歷史價格數據（開、高、低、收、量）被緩存為一個獨立的 `.csv` 文件。
    -   **基本面信息 (`.json`)**: 每支股票的基本面信息（如市值、行業、流通股本等）被緩存為一個 `.json` 文件。
-   **全局版本控制 (`version.txt`)**:
    -   每個市場的緩存目錄下都有一個 `version.txt` 文件，記錄著上次成功同步數據的日期。
    -   當您運行程序時，它會首先檢查這個版本文件。
    -   **快速模式**: 如果記錄的日期是今天，程序將進入「快速模式」，直接從本地緩存讀取所有數據，實現秒級啟動。
    -   **同步模式**: 如果日期不是今天，程序會自動進入「同步模式」，檢查每支股票的數據，僅下載需要更新的增量部分，然後在成功結束後更新 `version.txt`。

## 內建策略

目前專案內建了多種經過專業優化的策略，涵蓋了趨勢、動能、均值回歸等關鍵的市場分析維度。

### 1. VCP口袋支點 (VCP_PocketPivotStrategy)
**王牌策略**：此策略融合了兩種強大的交易模型，旨在VCP（波動收縮）形態的末端，尋找「口袋支點」作為早期介入信號，力求在股價主升浪開始前捕捉到最精準的買點。

### 2. 主力吸籌 (MainForceAccumulationStrategy)
此策略旨在更精準地捕捉大型機構投資者在拉升前，於市場上悄悄吸納籌碼的「潛伏」階段。

### 3. 黃金交叉 (GoldenCrossStrategy)
一個經典的長線趨勢反轉策略，加入了多重過濾器（如大盤狀態、趨勢斜率、RSI等）以提高信號的準確性。

### 4. 均值回歸 (MeanReversionStrategy)
旨在捕捉股價超跌後的潛在反彈機會，加入了多重確認機制（如止穩K線、威廉指標、成交量模式等）。

### 5. 內部日反轉 (InsideDayStrategy)
此策略旨在捕捉下降趨勢中的潛在轉折點，專門尋找「牛市中的回檔結束點」，形態要求嚴格，並有次日突破作為確認。

### 6. 布林帶擠壓突破 (BollingerSqueezeStrategy)
此策略旨在捕捉由長期盤整、波動率極度壓縮的狀態，轉變為趨勢行情（主升浪）的起爆點。

### 7. 換手率動量突破 (TurnoverMomentumBreakoutStrategy) (新)
此策略旨在尋找換手率近期有顯著放大，且股價處於短期上升趨勢的股票，預示著市場關注度提高和潛在的價格突破。
- **動量確認**: 要求當日換手率變化率遠高於近期平均，且換手率本身達到一定閾值（如 > 3%）。
- **趨勢過濾**: 確保股價處於短期上升趨勢（如收盤價 > 5日均線）。
- **基本面過濾**: 排除市值過小和價格過低的股票，以保證流動性和稳定性。

## 安裝與設定

為了確保所有依賴項的兼容性，建議使用 Python 3.12 建立虛擬環境。

1.  **建立虛擬環境 (使用 Python 3.12)**:
    ```bash
    python3.12 -m venv venv
    ```
2.  **啟用虛擬環境**:
    ```bash
    source venv/bin/activate  # macOS/Linux
    # 或 .\venv\Scripts\activate  # Windows
    ```
3.  **安裝 PyTorch (單獨安裝)**:
    由於 PyTorch 在某些 Python 版本和平台上可能需要特定的安裝方式，請使用以下命令單獨安裝：
    ```bash
    pip install torch torchvision torchaudio --extra-index-url https://download.pytorch.org/whl/cpu
    ```
4.  **安裝其餘所需套件**:
    ```bash
    pip install -r requirements.txt
    pip install -r Kronos/requirements.txt
    ```

## 使用方法

所有操作都透過 `main.py` 執行，並使用 `--market` 參數指定要分析的市場。

```bash
# 篩選美股 (首次運行會較慢，之後會啟用快速模式)
python3 main.py --market US

# 篩選港股
python3 main.py --market HK
```

## 如何擴充 (增加新策略)

這是此架構的核心優勢。若要增加一個新的選股策略，只需：

1.  在 `strategies/` 資料夾中建立一個新的 Python 檔案 (例如 `my_new_strategy.py`)。
2.  在該檔案中，建立一個繼承自 `BaseStrategy` 的新策略類別。
3.  實現 `name` 屬性 (策略名稱) 和 `run` 方法 (策略邏輯)。

**範例 `strategies/my_new_strategy.py`:**
```python
import pandas as pd
from .base_strategy import BaseStrategy

class MyNewStrategy(BaseStrategy):
    @property
    def name(self):
        return "我的新策略"

    def run(self, hist: pd.DataFrame, **kwargs) -> bool:
        # kwargs 中包含 'info' (dict), 'is_market_healthy' (bool) 等額外數據
        # 'info' 包含了市值、行業等基本面信息，可以直接使用
        info = kwargs.get('info', {})
        market_cap = info.get('marketCap', 0)

        # 實現您的策略邏輯
        # 例如，尋找市值大於100億且收盤價高於200日均線的股票
        if market_cap < 10_000_000_000:
            return False

        if len(hist) < 200:
            return False
        
        hist['MA200'] = hist['Close'].rolling(window=200).mean()
        latest_close = hist['Close'].iloc[-1]
        latest_ma200 = hist['MA200'].iloc[-1]

        if latest_close > latest_ma200:
            return True
        
        return False
```
完成後，分析引擎會自動偵測並執行您的新策略，無需修改任何其他程式碼！

## 新聞提取功能

專案包含了強大的港股新聞提取功能，可以從雅虎財經獲取特定股票的相關新聞：

### 使用新聞提取功能
若要提取特定股票的新聞，可以使用 `data_loader/get_yahoo_news.py` 腳本：

```bash
cd data_loader
python3 get_yahoo_news.py
```

### 功能特色
- **通用正則表達式匹配**：支援多種股票代碼格式（如 `0471.HK`, `0471`, `471`）
- **靈活新聞匹配**：不限定特定新聞類型，可提取包含股票代碼的所有相關新聞
- **自動新聞解析**：從雅虎財經HTML中提取新聞標題和連結
- **跨股票支援**：適用於所有港股股票代碼

---

## 開發日誌

-   **2025-10-14**:
    -   **新增策略 (換手率動量突破)**: 根據使用者需求，新增了`TurnoverMomentumBreakoutStrategy`，旨在捕捉換手率激增的動量股。
    -   **性能優化 (全局緩存)**: 引入了每個市場獨立的全局版本控制 (`version.txt`) 和 `info` 對象的JSON緩存。在數據為最新時，程序將以「快速模式」運行，完全從本地緩存加載數據，實現秒級啟動。
    -   **架構升級**: 重構了分析引擎，現在所有策略在运行时都可以接收包含市值、行業等基本面數據的 `info` 對象，使策略的過濾維度更豐富。

-   **2025-10-07**:
    -   **功能擴充 (基本面與新聞)**: 分析結果現在包含豐富的基本面數據和近期相關新聞，並會生成一份獨立的詳細報告檔案 (`_details.txt`)。
    -   **數據獲取優化**: 將歷史數據的獲取週期改為「全部歷史數據 (max)」。
    -   **錯誤修復**: 修復了因部分股票缺少財務數據而導致程式崩潰的 `ValueError`。

-   **2025-10-06**:
    -   **王牌策略整合**: 將VCP與口袋支點兩種進階邏輯整合為單一、強大的`VCP_PocketPivotStrategy`策略。

-   **2025-10-05**:
    -   **策略強化**: 為「均值回歸」與「黃金交叉」策略增加了多重過濾器。
    -   **功能增加**: 為輸出檔案加上日期，方便歷史回查。

-   **2025-10-04**:
    -   **核心重構**: 專案進行了重大重構，引入了模組化架構，分離了數據獲取、策略定義和分析引擎。